---
title: 'MAT 8444 Final Project'
author: "Katherine M. Prioli"
date: "May 10, 2019"
output:
  pdf_document: default
  html_document: default
geometry: margin = 0.5in
references:
- URL: https://fred.stlouisfed.org/series/A229RX0Q048SBEA 
  author:
  - family: Federal Reserve Bank of St. Louis
  id: fred_disposable
  issued:
    year: 2018
  title: Real Disposable Personal Income - Per Capita
- URL: https://fred.stlouisfed.org/series/TDSP
  author:
  - family: Federal Reserve Bank of St. Louis
  id: fred_debt
  issued:
    year: 2018
  title: Household Debt Service Payments as a Percent of Disposable Personal Income
- URL: https://fred.stlouisfed.org/series/A072RC1Q156SBEA
  author:
   - family: Federal Reserve Bank of St. Louis
  id: fred_savings
  issued:
    year: 2018
  title: Personal Saving as a Percent of Disposable Personal Income
- URL: https://github.com/kmprioliPROF/MAT_8444_Final_Project
  author:
  - family: Prioli
    given: Katherine M.
  id: kmpgit
  issued:
    month: 05
    year: 2019
  title: MAT_8444_Final_Project
- URL: http://pkg.robjhyndman.com/forecast
  author: 
  - family: Hyndman
    given: R
  - family: Athanasopoulos
    given: G
  - family: Bergmeir
    given: C
  - family: Caceres
    given: G
  - family: Chhay
    given: L
  - family: O'Hara-Wild
    given: M
  - family: Petropoulos
    given: F
  - family: Razbash
    given: S
  - family: Wang
    given: E
  - family: Yasmeen
    given: F
  id: pkg_forecast
  issued: 
    year: 2019
  title: forecast - Forecasting functions for time series and linear models.  R package version 8.5.
- URL: https://github.com/nickpoison/astsa
  author: 
  - family: Stoffer
    given: David
  id: pkg_astsa
  issued: 
    year: 2019
  title: astsa - Applied Statistical Time Series Analysis
abstract: "BACKGROUND text METHODS text RESULTS text CONCLUSION text"
---

```{r setup, include = FALSE, warning = FALSE, results = "hide", echo = FALSE, message = FALSE}
# Loading libraries

library(tidyverse)
library(forecast)      # For tidy time series analysis and graphics
library(lmtest)        # For getting p-values for Arima() output via coeftest()
library(ggthemr)       # For prettifying output
library(gridExtra)     # For grid.arrange()
library(grid)          # For arrangeGrob()
library(scales)        # For dollar_format()
library(kableExtra)    # For kable()
library(formattable)   # For currency() formatting

library(astsa)         # For sarima() and sarima.for()


ggthemr("flat")

i <- 1                  # For figure numbering
```


## **Background**


The objective of this study was to analyze US household debt service payments and personal savings as they relate to real per-capita disposable income over time.

## **Methods**

The analytic dataset consisted of three time series (TS) variables (Table 1).  All variables were obtained from the Federal Reserve Bank of St. Louis, all share a common year of valuation ($US 2012), and all have already been seasonally adjusted.  The data were limited to a common time horizon (Q1 1980 through Q3 2018), yielding 155 observations for each TS.

**Table 1.  Analytic Dataset Contents**

| **Variable**      	| **Description**                                                                                 	| **Reference**    	|
|-------------------	|-------------------------------------------------------------------------------------------------	|------------------	|
| `fred_disposable` 	| Per-capita disposable income, adjusted for inflation in chained $US 2012, seasonally adjusted   	| @fred_disposable 	|
| `fred_debt`       	| Household debt service payments as a percent of disposable personal income, seasonally adjusted 	| @fred_debt       	|
| `fred_savings`    	| Personal savings as a percentage of disposable personal income, seasonally adjusted              	| @fred_savings    	|


### *Data Exploration*

Each TS was separately explored via the `forecast::autoplot()` function, which yields plots for the raw time series along with its autocorrelation (ACF) and partial autocorrelation (PACF) functions.  Differencing was applied where needed.  Classical decomposition was performed for each TS via `decompose()` to understand the seasonality, if any, of these time series.  Where seasonality was suspected, a periodogram was generated to determine important frequencies.  To understand how savings may be dependent on debt, the cross-correlation function (CCF) was computed and plotted for differenced `fred_savings` vs. differenced `fred_debt`.

### *Modeling and Predictions*

To model the disposable income data, the `fred_disposable` TS was subset to a "training" dataset capped at Q3 2017, and was then passed into `forecast::auto.arima()`.  The model suggested by `auto.arima()` was fit using `forecast::Arima()`, and model fit was assesed both through analysis of residuals using `forecast::checkresiduals()` and by checking *p*-values via `lmtest::coeftest()`.  Squared and absolute value residuals were assessed for ARCH/GARCH behavior.  Finally, `forecast::forecast()` was used to predict the next three values (i.e., Q1 2018 through Q3 2018) along with a confidence interval, and these predictions were compared to the values found in the full dataset.

Since both debt service payments (`fred_debt`) personal savings (`fred_savings`) are given as a percentage of disposable personal income, it is reasonable to hypothesize that, as debt payments increase, personal savings may decrease.  Under this hypothesis, differenced debt was used to predict differenced savings using A LINEAR MODEL??? 

All analyses were performed in R (R v. 3.5.1, R Foundation for Statistical Computing, Vienna, Austria) using packages `forecast` (@pkg_forecast) and `astsa` (@pkg_astsa) for specialized time series calculations and plots.  All statistical tests were evaluated against a significance threshold of $\alpha = 0.05$.


## **Results**

Text

### *Data Exploration*

```{r wrangle, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 8}
fred_disposable <- read_csv("data/fred_disposable.csv") %>%
  rename(disposable = A229RX0Q048SBEA) %>%
  filter(DATE > "1979-12-31") %>% 
  select(-DATE) %>% 
  ts(start = 1980, frequency = 4)

fred_debt <- read_csv("data/fred_debt.csv") %>%
  rename(debt = TDSP) %>%
  select(-DATE) %>% 
  ts(start = 1980, frequency = 4)

fred_savings <- read_csv("data/fred_savings.csv") %>%
  rename(savings = A072RC1Q156SBEA) %>%
  filter(DATE > "1979-12-31") %>% 
  select(-DATE) %>% 
  ts(start = 1980, frequency = 4)

fred_disposable_train <- read_csv("data/fred_disposable.csv") %>%
  rename(disposable = A229RX0Q048SBEA) %>%
  filter(DATE > "1979-12-31" & DATE < "2018-01-01") %>% 
  select(-DATE) %>% 
  ts(start = 1980, frequency = 4)

fred_debt_train <- read_csv("data/fred_debt.csv") %>%
  rename(debt = TDSP) %>%
  filter(DATE > "1979-12-31" & DATE < "2018-01-01") %>% 
  select(-DATE) %>% 
  ts(start = 1980, frequency = 4)

fred_savings_train <- read_csv("data/fred_savings.csv") %>%
  rename(savings = A072RC1Q156SBEA) %>%
  filter(DATE > "1979-12-31" & DATE < "2018-01-01") %>% 
  select(-DATE) %>% 
  ts(start = 1980, frequency = 4)
```

Figures 1-3 show the `autoplot()` output for the three time series.  A generally increasing trend is seen in the plot of disposable income (Fig. 1).  Because these data are adjusted for inflation to \$US 2012, this trend represents a true increase in disposable income, not inflation, and thus the time series is not stationary.  The ACF plot shows a slow linear decline in $\hat{\rho}(h)$ with increasing *h*, suggesting nonstationarity.  The graphs of debt payments and savings (Figs. 2 and 3 respectively) do not exhibit any simple trend, but do fluctuate over time, though without any apparent seasonality (which is expected, because the data are provided in seasonally adjusted form).  Additionally, the ACF plots for both debt payments and savings are suggestive of nonstationarity due to their slow decline, and thus required differencing to achieve stationarity.

**Figure `r i`.  Real Disposable Personal Income Per Capita**

```{r f1_exploration_disp, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
fred_disp_plot <- ggtsdisplay(fred_disposable, points = FALSE, lag.max = 50,
                              main = "")
  #main = "Real Disposable Personal Income Per Capita")
i <- i + 1
```

**Figure `r i`.  Household Debt Service Payments as a Percent of Disposable Personal Income**

```{r f2_exploration_debt, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
fred_debt_plot <- ggtsdisplay(fred_debt, points = FALSE, lag.max = 50,
                              main = "")
  #main = "Household Debt Service Payments as a Percent of Disposable Personal Income")
i <- i + 1
```

**Figure `r i`.  Personal Savings as a Percent of Disposable Personal Income**

```{r f3_exploration_sav, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
fred_savings_plot <- ggtsdisplay(fred_savings, points = FALSE, lag.max = 50,
                              main = "")
  #main = "Personal Savings as a Percent of Disposable Personal Income")
i <- i + 1
```

Figures 4-6 show the results of differencing.  After differencing, stationarity appears to be met for all three TS.  ELABORATE FURTHER?

```{r exploration_diffs, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
ddisp <- diff(fred_disposable)
ddebt <- diff(fred_debt)
dsavings <- diff(fred_savings)
```

**Figure `r i`.  Real Disposable Personal Income Per Capita, Differenced Once**

```{r f4_exploration_ddisp, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
fred_disp_plot <- ggtsdisplay(ddisp, points = FALSE, lag.max = 50,
                              main = "")
  # main = "Real Disposable Personal Income Per Capita, Differenced Once")
i <- i + 1
```

**Figure `r i`.  Household Debt Service Payments as a Percent of Disposable Personal Income, Differenced Once**

```{r f5_exploration_ddebt, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
fred_debt_plot <- ggtsdisplay(ddebt, points = FALSE, lag.max = 50,
                              main = "")
  # main = "Household Debt Service Payments as a Percent of Disposable Personal Income, \nDifferenced Once")
i <- i + 1
```

**Figure `r i`.  Personal Savings as a Percent of Disposable Personal Income, Differenced Once**

```{r f6_exploration_dsav, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
fred_savings_plot <- ggtsdisplay(dsavings, points = FALSE, lag.max = 50,
                              main = "")
  # main = "Personal Savings as a Percent of Disposable Personal Income, Differenced Once")
i <- i + 1
```

Classical decomposition of the debt and savings TS is shown in Figs. 7-8.  For both TS, the seasonal component was small in magnitude when compared to the raw TS, with personal savings having the more pronounced seasonal component.

**Figure `r i`.  Debt Service Payments, Decomposition**

```{r f7_decompos_debt, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
fred_debt_decompose <- decompose(fred_debt) %>% 
  autoplot(main = "")
    #main = "Debt Service Payments, Decomposition")
fred_debt_decompose
i <- i + 1
```

**Figure `r i`.  Personal Savings, Decomposition**

```{r f8_decompos_sav, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
fred_savings_decompose <- decompose(fred_savings) %>% 
  autoplot(main = "")
    #main = "Personal Savings, Decomposition")
fred_savings_decompose
i <- i + 1
```

The cross-correlation function for differenced savings vs. differenced debt is shown in Fig. 9.  A cross-correlation is seen at lag $h = -1$; however, it is small in magnitude which suggests that differenced debt at $h = -1$ may be a weak predictor of differenced savings.

**Figure `r i`.  Differenced Savings vs. Differenced Debt**

```{r f9_ccf, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
ddbt <- as.vector(ddebt)
dsav <- as.vector(dsavings)
ccf_diff <- ggCcf(x = ddbt, y = dsav) + ylim(-1, 1) + ggtitle("")
  #ggtitle("Differenced Savings vs. Differenced Debt")
i <- i + 1
```

### *Modeling and Predictions*

```{r autoarima_disposable, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
aarima_disp <- auto.arima(fred_disposable_train)
#aarima_disp
```

For disposable income, the model suggested by `auto.arima()` was ARIMA $(1, 1, 0)$ with drift; `checkresiduals()` output for the fitted model is shown in Fig. 10.  The Ljung-Box test (not shown in Fig. 10) yielded a *p*-value of 0.3746 over 8 lags, indicating that the residuals are consistent with white noise.  This conclusion is supported by the plots in Fig. 10 - namely, the ACF plot looks like white noise, and the histogram demonstrates approximate normality of residuals with some deviation about the tails.  This model fits the training dataset reasonably well.

```{r Arima_disp, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
disp_fit <- Arima(fred_disposable_train, order = c(1, 1, 0), include.drift = TRUE)
disp_fit
disp_fit_pvals <- coeftest(disp_fit)   # Checking for significance of model terms
disp_fit_pvals
```

**Figure `r i`.  Residual Fit, Disposable Income Model: ARIMA(1, 1, 0) with Drift**

```{r f10_Arima_resid, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
checkresiduals(disp_fit, points = FALSE)
i <- i + 1
```

No ARCH/GARCH behavior is seen in the residuals for this model (Fig. 11).

**Figure `r i`.  Autocorrelation Function for Residuals**

```{r f11_disp_resids, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
disp_resids <- disp_fit$residuals
disp_AG_sq <- ggAcf(disp_resids * disp_resids, lag.max = 50) + ylim(-1, 1) + ggtitle("Squared Residuals")
disp_AG_abs <- ggAcf(abs(disp_resids), lag.max = 50) + ylim(-1, 1) + ggtitle("Absolute Value of Residuals")

grid.arrange(disp_AG_sq, disp_AG_abs, nrow = 1) #,
             # top = textGrob("Figure 11.  Autocorrelation Function for Residuals",
             #                gp = gpar(fontsize = 14, fontface = "bold", col = "#34495E"),
             #                x = 0.025, hjust = 0))
i <- i + 1
```

```{r forecast_disp, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
disp_forecast <- disp_fit %>%
  forecast(h = 3, level = 95)

disp_train_vec <- as.vector(fred_disposable_train)
time <- seq(from = 1980, to = 2017.75, by = 0.25)
disp_train_df <- as.tibble(cbind(time, disp_train_vec))

disp_preds <- as.vector(disp_forecast$mean)
predtime <- seq(from = 2018, to = 2018.5, by = 0.25)
disp_pred_df <- as.tibble(cbind(predtime, disp_preds))

disp_actual_df <- as.tibble(cbind(predtime, as.vector(tail(fred_disposable, 3)))) %>% 
  rename(disp_actual = V1)

disp_preds_kable <- as.tibble(cbind(c("Q1 2018", "Q2 2018", "Q3 2018"), 
                                    disp_preds, 
                                    as.vector(tail(fred_disposable, 3)))) %>% 
  mutate(disp_preds = currency(disp_preds, digits = 0, symbol = "$")) %>% 
  mutate(V2 = currency(V2, digits = 0, symbol = "$")) %>% 
  rename(Time = V1,
         `Predicted Values` = disp_preds,
         `Actual Values` = V2) %>% 
  kable(format = "markdown")
```

Predicted and observed disposable income values for Q1 through Q3 2018 are shown in Table 2.  The observed values are marginally greater than predicted values in each case, and fall within the 95% prediction interval (Fig. 12).

**Table 2.  Predicted and Observed Values, Disposable Income, Q1 through Q3**

```{r disp_pred_kbl, echo = FALSE}
disp_preds_kable
```

**Figure `r i`.  Predicted vs. Actual Values, Disposable Income**

```{r f12_forecast_disp_plot, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
disp_forecast_plot <- disp_fit %>% 
  forecast(h = 3, level = 95) %>%
  autoplot() + 
  geom_line(data = disp_pred_df, aes(x = predtime, y = disp_preds), color = "red") +
  geom_point(data = disp_pred_df, aes(x = predtime, y = disp_preds), color = "red", size = 1.0) +
  geom_line(data = disp_actual_df, aes(x = predtime, y = disp_actual)) +
  scale_y_continuous(labels = dollar_format(prefix = "$")) +
  guides(fill = FALSE) +
  xlab("Year") +
  ylab("") #+
  #ggtitle("Predicted vs. Actual Values, Disposable Income")
disp_forecast_plot

i <- i + 1
```


```{r autoarima_debt, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
aarima_debt <- auto.arima(fred_debt_train)
#aarima_debt
```

For debt, `auto.arima()` suggested ARIMA $(1, 1, 2) \times (1, 0, 1)_{4}$.  Output from `checkresiduals()` for the fitted model is shown in Fig. 13.  The Ljung-Box test was nonsignificant at $p = 0.4033$ over 8 lags; additionally, the ACF plot has the appearance of white noise and the histogram shows that residuals are approximately normally distributed.  Thus this model fits well.

```{r Arima_debt, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 5}
debt_fit <- Arima(fred_debt_train, order = c(1, 1, 2), seasonal = c(1, 0, 1), include.drift = FALSE)
debt_fit

checkresiduals(debt_fit, points = FALSE)
```

```{r autoarima_savings, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 4}
aarima_savings <- auto.arima(fred_savings_train)
#aarima_savings
```

For savings, `auto.arima()` suggested ARMA $(1, 1, 0) \times (0, 0, 1)_{4}$, with no seasonal component.  The `checkresiduals()` output is presented in Fig. 14.  The Ljung-Box test was once again nonsignificant at $p = 0.8278$ over 8 lags, the ACF plot of residuals is consistent with white noise, and the histogram shows general normality of residuals with some deviation about the tails; thus, the model fits well.

```{r Arima_savings, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
savings_fit <- Arima(fred_savings_train, order = c(1, 1, 0), seasonal = c(0, 0, 1), include.drift = FALSE)
savings_fit

checkresiduals(savings_fit, points = FALSE)
```





## **Discussion**

Text


### *Limitations*

Text


## **Conclusion**

Text



## **References**